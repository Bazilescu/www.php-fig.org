name: php-fig-website
type: php:7.3

build:
  flavor: composer

web:
  locations:
    "/":
      root: "output_dev"
      index:
        - "index.html"
      expires: 300s
      scripts: true
      allow: false
      rules:
        \.(css|js|gif|jpe?g|png|ttf|eot|woff2?|otf|html|ico|svg?)$:
          allow: true
        ^/(robots|humans)\.txt$:
          allow: true

disk: 1024

hooks:
  build: |
    set -e
    cat /etc/*release
    php -v
    ruby -v
    curl -sS https://platform.sh/cli/installer | php
    gem install bundler

    if [ "$PLATFORM_BRANCH" != master ]; then
      export DEPLOY_HOST="https://www---$PLATFORM_ENVIRONMENT-$PLATFORM_PROJECT.us.platform.sh"
      php -r "echo preg_replace('/host:.*/', 'host: ' . getenv('DEPLOY_HOST'), fread(STDIN, 4096));" < app/config/sculpin_site.yml > app/config/sculpin_site.yml.tmp
      mv app/config/sculpin_site.yml.tmp app/config/sculpin_site.yml
    fi

    bin/install.sh
    bin/build.sh


crons:
    renewcert:
        # Force a redeploy at 6 am (UTC) on the 14th and 28th of every month.
        spec: '0 6 14,28 * *'
        cmd: |
            if [ "$PLATFORM_BRANCH" = master ]; then
                platform redeploy --yes --no-wait
            fi
